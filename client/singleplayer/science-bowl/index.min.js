console.log("Science Bowl script loaded");import api from"../../scripts/api/index.js";import questionStats from"../../scripts/auth/question-stats.js";import audio from"../../audio/index.js";import{MODE_ENUM}from"../../../quizbowl/constants.js";import Player from"../../../quizbowl/Player.js";import ClientScienceBowlRoom from"../ClientScienceBowlRoom.js";import{arrayToRange,rangeToArray}from"../../scripts/utilities/ranges.js";import createTossupGameCard from"../../scripts/utilities/tossup-game-card.js";import{getDropdownValues}from"../../scripts/utilities/dropdown-checklist.js";import ScienceBowlCategoryModal from"../../scripts/components/ScienceBowlCategoryModal.min.js";import DifficultyDropdown from"../../scripts/components/DifficultyDropdown.min.js";import upsertPlayerItem from"../../scripts/upsertPlayerItem.js";import aiBots from"../ai-mode/ai-bots.js";import AIBot from"../ai-mode/AIBot.js";import{SBCATEGORIES}from"../../../quizbowl/categories.js";import ScienceBowlCategoryManager from"../../../quizbowl/ScienceBowlCategoryManager.js";let maxPacketNumber=24;const modeVersion="2025-01-14",queryVersion="2025-05-07",settingsVersion="2024-10-16",USER_ID="user",USERNAME="user",VERSION="2025-05-07",room=new ClientScienceBowlRoom;window.room=room,room.players[USER_ID]=new Player(USER_ID),room.categoryManager=new ScienceBowlCategoryManager;// Load saved category state
const savedCategoryState=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-categories")||"{}");console.log("Loading saved category state:",savedCategoryState),savedCategoryState.version===queryVersion&&(room.categoryManager.import(savedCategoryState),room.query.subjects=room.categoryManager.categories,console.log("Updating checkbox states after loading saved state"),document.querySelectorAll(".category-checkbox").forEach(a=>{a.checked=room.categoryManager.categories.includes(a.id)}));const aiBot=new AIBot(room);aiBot.setAIBot(aiBots["average-high-school"][0]),aiBot.active=!1;const socket={send:onmessage,sendToServer:a=>room.message(USER_ID,a)};room.sockets[USER_ID]=socket;function onmessage(a){const b=JSON.parse(a);switch(b.type){case"alert":return window.alert(b.message);case"buzz":return buzz(b);case"clear-stats":return clearStats(b);case"end":return next(b);case"end-of-set":return endOfSet(b);case"give-answer":return giveAnswer(b);case"next":return next(b);case"no-questions-found":return noQuestionsFound(b);case"pause":return pause(b);case"reveal-answer":return revealAnswer(b);case"reset-question":return document.getElementById("question").textContent="";case"set-categories":return setCategories(b);case"set-difficulties":return setDifficulties(b);case"set-mode":return setMode(b);case"set-reading-speed":return setReadingSpeed(b);case"set-strictness":return setStrictness(b);case"set-packet-numbers":return setPacketNumbers(b);case"set-set-name":return setSetName(b);case"set-year-range":return setYearRange(b);case"skip":return next(b);case"start":return next(b);case"timer-update":return updateTimerDisplay(b.timeRemaining);case"toggle-ai-mode":return toggleAiMode(b);case"toggle-correct":return toggleCorrect(b);case"toggle-powermark-only":return togglePowermarkOnly(b);case"toggle-rebuzz":return toggleRebuzz(b);case"toggle-show-history":return toggleShowHistory(b);case"toggle-standard-only":return toggleStandardOnly(b);case"toggle-timer":return toggleTimer(b);case"toggle-type-to-answer":return toggleTypeToAnswer(b);case"update-question":return updateQuestion(b)}}function buzz({timer:a,userId:b,username:c}){if(audio.soundEffects&&audio.buzz.play(),b===USER_ID){document.getElementById("pause").disabled=!0;const a=function(){const a=document.getElementById("type-to-answer");return!a||a.checked;// default to enabled if control absent
}();a&&(document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),document.getElementById("buzz").disabled=!0)}}function clearStats({userId:a}){updateStatDisplay(room.players[a])}function endOfSet(){window.alert("You have reached the end of the set")}async function giveAnswer({directive:a,directedPrompt:b,perQuestionCelerity:c,score:d,tossup:e,userId:f,isCorrect:g}){if("prompt"===a)return document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),void(document.getElementById("answer-input").placeholder=b?`Prompt: "${b}"`:"Prompt");if(f!==USER_ID)aiBot.active&&upsertPlayerItem(aiBot.player);else// Update the player's score based on isCorrect
if(g){const a=e?.isTossup?4:10;// 4 points for tossup, 10 for bonus
room.players[USER_ID].score+=a,updateStatDisplay()}document.getElementById("answer-input").value="",document.getElementById("answer-input").blur(),document.getElementById("answer-input").placeholder="Enter answer",document.getElementById("answer-input-group").classList.add("d-none");// Enable next button and update its text
const h=document.getElementById("next");h.disabled=!1,h.textContent="Next",room.settings.rebuzz&&"reject"===a&&(document.getElementById("buzz").disabled=!1,document.getElementById("buzz").textContent="Buzz",document.getElementById("pause").disabled=!1),audio.soundEffects&&f===USER_ID&&(g?audio.correct.play():audio.incorrect.play())}async function next({packetLength:a,oldTossup:b,tossup:c,type:d}){console.log("next() called with:",{packetLength:a,oldTossup:b,nextTossup:c,type:d}),"start"===d&&(console.log("Handling start type"),document.getElementById("next").disabled=!1,document.getElementById("settings").classList.add("d-none")),"start"!==d&&(console.log("Creating tossup game card for old tossup"),createTossupGameCard({starred:room.mode===MODE_ENUM.STARRED||room.mode!==MODE_ENUM.LOCAL&&null,tossup:b})),console.log("Clearing all displays...");const e={question:document.getElementById("question"),answerDisplay:document.getElementById("answer-display"),userAnswer:document.getElementById("user-answer"),toggleCorrect:document.getElementById("toggle-correct")};console.log("Found elements:",{question:!!e.question,answerDisplay:!!e.answerDisplay,userAnswer:!!e.userAnswer,toggleCorrect:!!e.toggleCorrect}),e.question&&(e.question.textContent=""),e.answerDisplay&&(e.answerDisplay.textContent=""),e.userAnswer&&(e.userAnswer.textContent=""),e.toggleCorrect&&(e.toggleCorrect.textContent="I was wrong",e.toggleCorrect.classList.add("d-none")),hideAIHelpSection();// Hide answer input if it's visible
const f=document.getElementById("answer-input-group");if(f&&f.classList.add("d-none"),console.log("Displays cleared. Current content:",{question:e.question?.textContent,answerDisplay:e.answerDisplay?.textContent,userAnswer:e.userAnswer?.textContent}),"end"===d?(console.log("Handling end type"),document.getElementById("buzz").disabled=!0,document.getElementById("next").disabled=!0,document.getElementById("pause").disabled=!0):(console.log("Setting up for next question"),document.getElementById("buzz").textContent="Buzz",document.getElementById("buzz").disabled=!1,document.getElementById("next").textContent="Skip",document.getElementById("next").disabled=!1,document.getElementById("packet-number-info").textContent=c.packet.number,document.getElementById("packet-length-info").textContent=room.mode===MODE_ENUM.SET_NAME?a:"-",document.getElementById("pause").textContent="Pause",document.getElementById("pause").disabled=!1,document.getElementById("question-number-info").textContent=c.number,document.getElementById("set-name-info").textContent=c.set.name),("end"===d||"next"===d)&&room.previous.userId===USER_ID&&room.mode!==MODE_ENUM.LOCAL){const a=room.previous.isCorrect?room.previous.inPower?room.previous.powerValue:10:room.previous.endOfQuestion?0:room.previous.negValue;questionStats.recordTossup({_id:room.previous.tossup._id,celerity:room.previous.celerity,isCorrect:room.previous.isCorrect,multiplayer:!1,pointValue:a}),recordSessionScienceBowlStat(room.previous.tossup?.subject,room.previous.isCorrect,room.previous.tossup?._id),"function"==typeof window.refreshScienceBowlSubjectStats&&window.refreshScienceBowlSubjectStats()}}function noQuestionsFound(){window.alert("No questions found")}function pause({paused:a}){console.log("Pause function called with paused:",a),console.log("Current room state:",{tossupProgress:room.tossupProgress,wordIndex:room.wordIndex,questionSplit:room.questionSplit?.length}),document.getElementById("buzz").disabled=a,document.getElementById("pause").textContent=a?"Resume":"Pause",a||"READING"!==room.tossupProgress?console.log("Not resuming question reading:",{paused:a,tossupProgress:room.tossupProgress}):(console.log("Resuming question reading"),room.readQuestion(Date.now()))}function revealAnswer({answer:a,question:b,correctAnswer:c,isCorrect:d}){console.log("revealAnswer called with:",{answer:a,question:b,correctAnswer:c,isCorrect:d});const e={question:document.getElementById("question"),answerDisplay:document.getElementById("answer-display"),userAnswer:document.getElementById("user-answer"),pause:document.getElementById("pause"),buzz:document.getElementById("buzz"),start:document.getElementById("start"),toggleCorrect:document.getElementById("toggle-correct")};console.log("Found elements in revealAnswer:",{question:!!e.question,answerDisplay:!!e.answerDisplay,userAnswer:!!e.userAnswer,pause:!!e.pause,buzz:!!e.buzz,start:!!e.start,toggleCorrect:!!e.toggleCorrect}),e.question&&(console.log("Setting question content"),e.question.innerHTML=b);// Use the correct answer from the tossup if available
const f=c||window.room?.tossup?.answer;if(console.log("Using correct answer:",f),e.answerDisplay&&(console.log("Setting answer display content"),e.answerDisplay.innerHTML="ANSWER: "+f),e.userAnswer&&(console.log("Setting user answer content"),e.userAnswer.innerHTML="YOUR ANSWER: "+a),console.log("Current display content:",{question:e.question?.innerHTML,answerDisplay:e.answerDisplay?.innerHTML,userAnswer:e.userAnswer?.innerHTML}),e.pause&&(e.pause.disabled=!0),e.buzz&&(e.buzz.disabled=!0,e.buzz.textContent="Buzz"),e.start&&(e.start.disabled=!1,e.start.textContent="Next"),e.toggleCorrect){e.toggleCorrect.classList.remove("d-none");// Use the isCorrect flag if provided, otherwise fall back to room.previous.isCorrect
const a=void 0===d?room.previous.isCorrect:d;e.toggleCorrect.textContent=a?"I was wrong":"I was right"}// Show AI help section when answer is revealed
console.log("About to show AI help section from revealAnswer"),showAIHelpSection()}function setCategories({alternateSubcategories:a,categories:b,subcategories:c,percentView:d,categoryPercents:e}){// Save category state to localStorage
room.categoryManager.loadCategoryModal(),window.localStorage.setItem("singleplayer-science-bowl-categories",JSON.stringify({...room.categoryManager.export(),version:queryVersion})),window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setDifficulties({difficulties:a}){window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setStrictness({strictness:a}){const b=document.getElementById("set-strictness"),c=document.getElementById("strictness-display");b&&(b.value=a),c&&(c.textContent=a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function setPacketNumbers({packetNumbers:a}){document.getElementById("packet-number").value=arrayToRange(a),window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setReadingSpeed({readingSpeed:a}){const b=document.getElementById("reading-speed"),c=document.getElementById("reading-speed-display");b&&(b.value=a),c&&(c.textContent=a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}async function setSetName({setName:a,setLength:b}){document.getElementById("set-name").value=a;// make border red if set name is not in set list
const c=!a||api.getSetList().includes(a);document.getElementById("set-name").classList.toggle("is-invalid",!c),maxPacketNumber=b,document.getElementById("packet-number").placeholder="Packet Numbers"+(maxPacketNumber?` (1-${maxPacketNumber})`:""),window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setYearRange({minYear:a,maxYear:b}){$("#slider").slider("values",[a,b]),document.getElementById("year-range-a").textContent=a,document.getElementById("year-range-b").textContent=b,window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleAiMode({aiMode:a}){a&&upsertPlayerItem(aiBot.player),aiBot.active=a;const b=document.getElementById("ai-settings");b&&(b.disabled=!a);const c=document.getElementById("toggle-ai-mode");c&&(c.checked=a),document.getElementById("player-list-group").classList.toggle("d-none",!a),document.getElementById("player-list-group-hr").classList.toggle("d-none",!a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleCorrect({correct:a,userId:b}){b!==USER_ID||document.getElementById("toggle-correct").classList.add("d-none")}function togglePowermarkOnly({powermarkOnly:a}){document.getElementById("toggle-powermark-only").checked=a,window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleRebuzz({rebuzz:a}){const b=document.getElementById("toggle-rebuzz");b&&(b.checked=a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function setMode({mode:a,setName:b}){document.getElementById("set-mode").value=a,document.getElementById("local-packet-settings").classList.toggle("d-none","local packet"!==a),document.getElementById("set-settings").classList.toggle("d-none","select by set name"!==a),document.getElementById("difficulty-settings").classList.toggle("d-none","local packet"===a),document.getElementById("toggle-powermark-only").disabled="local packet"===a,document.getElementById("toggle-standard-only").disabled="local packet"===a,document.getElementById("category-select-button").disabled="local packet"===a;const c=document.getElementById("ai-settings");c&&(c.disabled="local packet"===a||!room.settings.aiMode);const d=document.getElementById("toggle-ai-mode");d&&(d.disabled="local packet"===a),document.getElementById("clear-stats").disabled="local packet"===a,document.getElementById("set-name").value=b||"",window.localStorage.setItem("singleplayer-science-bowl-mode",JSON.stringify({mode:a,setName:b,version:modeVersion}))}function toggleShowHistory({showHistory:a}){const b=document.getElementById("toggle-show-history");b&&(b.checked=a),document.getElementById("room-history").classList.toggle("d-none",!a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleStandardOnly({standardOnly:a}){document.getElementById("toggle-standard-only").checked=a,window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleTimer({timer:a}){const b=document.getElementById("toggle-timer");b&&(b.checked=a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleTypeToAnswer({typeToAnswer:a}){const b=document.getElementById("type-to-answer");b&&(b.checked=a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function updateQuestion({word:a}){const b=document.getElementById("question");b&&(a.startsWith("\n")?(b.innerHTML+="<br>",b.innerHTML+=a.substring(1)):(b.innerHTML&&!b.innerHTML.endsWith(" ")&&(b.innerHTML+=" "),b.innerHTML+=a));// If the word starts with a newline, it's a multiple-choice option
}// Make updateStatDisplay globally accessible
window.updateStatDisplay=function(){console.log("updateStatDisplay called"),console.log("Current room state:",{room:window.room,tossup:window.room?.tossup,isTossup:window.room?.tossup?.isTossup});// Get the current score from the statline element
const a=document.getElementById("statline"),b=parseInt(a.textContent.split(": ")[1])||0;console.log("Current score:",b);// Check if current question is a tossup
// A question is a tossup if isTossup is true
const c=!0===window.room?.tossup?.isTossup;console.log("Is tossup question?",c,"because isTossup is:",window.room?.tossup?.isTossup);// Increment score by 4 for tossup, 10 for bonus
const d=c?4:10;console.log("Points to add:",d);const e=b+d;console.log("New score:",e),a.textContent=`SCORE: ${e}`};function recordSessionScienceBowlStat(a,b,c){if("function"==typeof window.sbRecordSessionStat)return void window.sbRecordSessionStat({subject:a,isCorrect:b,tossupId:c});if(!a)return void console.warn("[Science Bowl] Skipping session stat (no subject)",{isCorrect:b,tossupId:c});const d=a.toUpperCase();console.log("[Science Bowl] Recording session stat (fallback)",{subject:d,originalSubject:a,isCorrect:b,tossupId:c}),fetch("/api/science-bowl/session-stats",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject:d,isCorrect:b})}).then(async a=>{if(console.log("[Science Bowl] Session stat response",{status:a.status}),!a.ok){const b=await a.text();throw new Error(`Session stat failed (${a.status}): ${b}`)}return a.json()}).then(a=>{console.log("[Science Bowl] Session stat updated payload",a)}).catch(a=>{console.error("[Science Bowl] Failed to record session stat",{error:a,subject:d,isCorrect:b,tossupId:c})})}function updateTimerDisplay(a){const b=Math.floor(a/10);document.getElementById("timer").querySelector(".face").textContent=b,document.getElementById("timer").querySelector(".fraction").textContent="."+a%10}// Initialize the room
document.addEventListener("DOMContentLoaded",()=>{console.log("DOM loaded, setting up event handlers"),console.log("Using global room instance:",window.room);const a=window.room;console.log("Category manager:",a.categoryManager),console.log("Initial categories:",a.categoryManager.categories),document.getElementById("start").disabled=!1,document.getElementById("start").textContent="Start/Next",document.getElementById("buzz").disabled=!0,document.getElementById("pause").disabled=!1,document.getElementById("pause").textContent="Pause";// Load saved settings
const b=localStorage.getItem("singleplayer-science-bowl-settings");if(console.log("Loading saved settings:",b),b){const c=JSON.parse(b);if(c.version===settingsVersion){a.settings={...a.settings,...c};const b=document.getElementById("toggle-ai-mode");b&&(b.checked=a.settings.aiMode);const d=document.getElementById("toggle-rebuzz");d&&(d.checked=a.settings.rebuzz);const e=document.getElementById("toggle-show-history");e&&(e.checked=a.settings.showHistory);const f=document.getElementById("toggle-timer");f&&(f.checked=a.settings.timer);const g=document.getElementById("type-to-answer");g&&(g.checked=a.settings.typeToAnswer);const h=document.getElementById("set-strictness");h&&(h.value=a.settings.strictness);const i=document.getElementById("strictness-display");i&&(i.textContent=a.settings.strictness);const j=document.getElementById("reading-speed");j&&(j.value=a.settings.readingSpeed);const k=document.getElementById("reading-speed-display");k&&(k.textContent=a.settings.readingSpeed)}}// Load saved category state
const c=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-categories")||"{}");console.log("Loading saved category state:",c),c.version===queryVersion&&(a.categoryManager.import(c),a.query.subjects=a.categoryManager.categories,console.log("Updating checkbox states after loading saved state"),document.querySelectorAll(".category-checkbox").forEach(b=>{b.checked=a.categoryManager.categories.includes(b.id)}));// Load saved mode
const d=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-mode")||"{}");d.version===modeVersion&&setMode(d);// Load saved query
const e=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-query")||"{}");e.version===queryVersion&&(a.query={...a.query,...e},document.getElementById("set-name").value=a.query.setName,document.getElementById("packet-number").value=arrayToRange(a.query.packetNumbers),$("#slider").slider("values",[a.query.minYear,a.query.maxYear]),document.getElementById("year-range-a").textContent=a.query.minYear,document.getElementById("year-range-b").textContent=a.query.maxYear),console.log("Setting up event handlers immediately");const f=document.getElementById("category-modal-root");if(console.log("Found modal element:",f),f){console.log("About to initialize category modal handlers");try{// Add modal show/hide handlers
f.addEventListener("show.bs.modal",()=>{console.log("Modal shown"),console.log("Current categories:",a.categoryManager.categories),a.categoryManager.loadCategoryModal(),document.querySelectorAll(".category-checkbox").forEach(b=>{b.checked=a.categoryManager.categories.includes(b.id)})}),f.addEventListener("hidden.bs.modal",()=>{console.log("Modal hidden"),console.log("Current categories:",a.categoryManager.categories),socket.sendToServer({type:"set-categories",...a.categoryManager.export()})}),console.log("Modal show/hide handlers attached"),console.log("Category modal handlers initialized successfully")}catch(a){console.error("Error initializing category modal:",a)}}else console.error("Modal root element not found");// Add other event handlers
document.getElementById("answer-form").addEventListener("submit",b=>{b.preventDefault();const c=document.getElementById("answer-input").value;a.message(USER_ID,{type:"give-answer",givenAnswer:c})}),document.getElementById("buzz").addEventListener("click",()=>{a.message(USER_ID,{type:"buzz"})}),document.getElementById("clear-stats").addEventListener("click",()=>{a.message(USER_ID,{type:"clear-stats"})});// Add start button handler with detailed logging
const g=document.getElementById("start");console.log("Found start button:",g),g?(g.addEventListener("click",()=>{console.log("Start/Next button clicked"),console.log("Current room state:",{categories:a.categoryManager.categories,query:a.query,mode:a.mode}),a.query.subjects=a.categoryManager.categories,console.log("Starting with categories:",a.categoryManager.categories),a.message(USER_ID,{type:"start"})}),console.log("Start button handler attached")):console.error("Start button not found!"),document.getElementById("toggle-correct").addEventListener("click",()=>{a.message(USER_ID,{type:"toggle-correct"})});const h=document.getElementById("toggle-ai-mode");h&&h.addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-ai-mode",aiMode:b.target.checked})});const i=document.getElementById("toggle-rebuzz");i&&i.addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-rebuzz",rebuzz:b.target.checked})});const j=document.getElementById("toggle-show-history");j&&j.addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-show-history",showHistory:b.target.checked})});const k=document.getElementById("toggle-timer");k&&k.addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-timer",timer:b.target.checked})});const l=document.getElementById("type-to-answer");l&&l.addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-type-to-answer",typeToAnswer:b.target.checked})});const m=document.getElementById("set-strictness");m&&m.addEventListener("input",b=>{a.message(USER_ID,{type:"set-strictness",strictness:parseInt(b.target.value)})});const n=document.getElementById("reading-speed");n&&n.addEventListener("input",b=>{a.message(USER_ID,{type:"set-reading-speed",readingSpeed:parseInt(b.target.value)})}),document.getElementById("pause").addEventListener("click",()=>{console.log("Pause button clicked"),a.message(USER_ID,{type:"pause"})}),document.addEventListener("keydown",b=>{if("INPUT"!==b.target.tagName)switch(b.key){case" ":return a.message(USER_ID,{type:"buzz"});case"n":return hideAIHelpSection(),a.message(USER_ID,{type:"start"});case"p":return a.message(USER_ID,{type:"pause"});case"s":return hideAIHelpSection(),a.message(USER_ID,{type:"start"})}});// Also clear AI panels immediately when clicking the Start/Next button
const o=document.getElementById("start");o&&o.addEventListener("click",()=>{try{hideAIHelpSection()}catch(a){}}),a.message(USER_ID,{type:"start"}),console.log("About to initialize AI help...");// Initialize immediately if DOM is ready, otherwise wait
try{initializeAIHelp()}catch(a){console.warn("initializeAIHelp threw, will retry on DOMContentLoaded:",a)}// Fallback: click delegation and mutation observer do not depend on timing
setupAIHelpClickDelegation(),observeAnswerReveal(),console.log("AI help initialization complete!"),hideAIHelpSection()});// AI Help Functions
function showAIHelpSection(){console.log("showAIHelpSection called");const a=document.getElementById("ai-help-section");if(console.log("AI help section element:",a),a){a.classList.remove("d-none"),console.log("AI help section shown"),hideAIExplanation();// Bring the AI help section into view for visibility
try{a.scrollIntoView({behavior:"smooth",block:"nearest"})}catch(a){// no-op if scrollIntoView not available
}}else console.error("AI help section element not found!")}function hideAIHelpSection(){console.log("hideAIHelpSection called");const a=document.getElementById("ai-help-section");a&&(a.classList.add("d-none"),console.log("AI help section hidden"),hideAIExplanation())}function hideAIExplanation(){const a=document.getElementById("ai-explanation"),b=document.getElementById("explanation-content"),c=document.getElementById("explanation-loading");a&&a.classList.add("d-none"),b&&(b.innerHTML=""),c&&c.classList.add("d-none");// Also hide and clear suggested reading if present
const d=document.getElementById("suggested-reading"),e=document.getElementById("suggested-reading-content"),f=document.getElementById("suggested-reading-loading");d&&d.classList.add("d-none"),e&&(e.innerHTML=""),f&&f.classList.add("d-none");// Also hide and clear extra practice if present
const g=document.getElementById("extra-practice"),h=document.getElementById("extra-practice-content"),i=document.getElementById("extra-practice-loading");g&&g.classList.add("d-none"),h&&(h.innerHTML=""),i&&i.classList.add("d-none")}function showAIExplanation(){const a=document.getElementById("ai-explanation");a&&a.classList.remove("d-none")}function showLoadingState(){const a=document.getElementById("explanation-content"),b=document.getElementById("explanation-loading");a&&(a.innerHTML=""),b&&b.classList.remove("d-none")}function hideLoadingState(){const a=document.getElementById("explanation-loading");a&&a.classList.add("d-none")}function displayExplanation(a){const b=document.getElementById("explanation-content");b&&(b.innerHTML=a.replace(/\n/g,"<br>"))}function renderSuggestions(a){const b=document.getElementById("suggested-reading"),c=document.getElementById("suggested-reading-content"),d=document.getElementById("suggested-reading-loading");if(b&&c){if(b.classList.remove("d-none"),d&&d.classList.add("d-none"),!Array.isArray(a)||0===a.length)return void(c.innerHTML="<div class=\"alert alert-warning\">No suggestions returned.</div>");const e=a.map(a=>{const b=a.title||"Resource",c=a.type?`<span class="badge bg-secondary ms-2">${a.type}</span>`:"",d=a.notes?`<div class="small text-muted">${a.notes}</div>`:"",e=a.link?`<a href="${a.link}" target="_blank" rel="noopener">${a.link}</a>`:"";return`<li class="mb-2"><strong>${b}</strong> ${c}<br>${d}${e?"<div>"+e+"</div>":""}</li>`}).join("");c.innerHTML=`<ul class="mb-0 ps-3">${e}</ul>`}}async function getAIExplanation(){try{// Get current question and answer
const a=document.getElementById("question"),b=document.getElementById("answer-display");if(!a||!b)return void console.error("Question or answer elements not found");const c=a.textContent.trim(),d=b.textContent.trim(),e=d.replace(/^ANSWER:\s*/i,""),f=document.getElementById("user-answer"),g=f?.textContent?.trim()||"",h=g.replace(/^YOUR ANSWER:\s*/i,""),i=!0===window.room?.previous?.isCorrect,j=!!(window.room?.tossup?.is_mcq&&Array.isArray(window.room?.tossup?.options)),k=j?window.room.tossup.options:void 0;// Strip the leading "ANSWER:" label if present before sending to API
// Also capture the user's answer if present
// Try to detect last correctness from room state
// Include MCQ options if available from room state
if(!c||!e)return void alert("Please wait for the question to be fully loaded and answered before requesting AI help.");// Show loading state
showLoadingState(),showAIExplanation();// Make API call to get AI explanation
const l=await fetch("/api/ai-help/explain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:c,answer:e,category:getCurrentCategory(),isMcq:j,options:k,userAnswer:h,userIsCorrect:i})});if(!l.ok){const a=await l.json();throw new Error(a.error||"Failed to get AI explanation")}const m=l.headers.get("content-type")||"";if(!m.includes("application/json")){const a=await l.text();throw new Error("Unexpected non-JSON response: "+a.slice(0,60))}const n=await l.json();// Hide loading and display explanation
hideLoadingState(),displayExplanation(n.explanation)}catch(a){console.error("Error getting AI explanation:",a),hideLoadingState();// Show error message
const b=document.getElementById("explanation-content");b&&(b.innerHTML=`
        <div class="alert alert-danger">
          <strong>Error:</strong> ${a.message}
          <br><small>Please try again later or contact support if the problem persists.</small>
        </div>
      `)}}// Robust click binding: delegate to document so handler exists even if button is added later
function setupAIHelpClickDelegation(){window.__aiHelpClickDelegationAttached||(document.addEventListener("click",a=>{const b=a.target?.closest&&a.target.closest("#get-ai-help");if(b){a.preventDefault();try{console.log("Delegated click: Get AI Explanation"),getAIExplanation()}catch(a){console.error("Delegated click failed:",a)}}}),window.__aiHelpClickDelegationAttached=!0)}// Fallback: observe when the answer is revealed in the DOM, then show + auto-fetch
function observeAnswerReveal(){try{const a=document.getElementById("answer-display");if(!a)return;if(window.__aiHelpObserverAttached)return;const b=new MutationObserver(()=>{const b=a.textContent?.trim()||"";0<b.length&&(console.log("MutationObserver detected answer reveal. Showing AI help..."),showAIHelpSection())});b.observe(a,{childList:!0,subtree:!0,characterData:!0}),window.__aiHelpObserverAttached=!0}catch(a){console.warn("observeAnswerReveal setup failed:",a)}}function getCurrentCategory(){// Try to get category from room state or UI
if(room&&room.categoryManager&&0<room.categoryManager.categories.length)return room.categoryManager.categories[0];// Return first selected category
// Fallback to checking which category checkboxes are checked
const a=document.querySelectorAll(".category-checkbox:checked");return 0<a.length?a[0].id:"Science";// Default fallback
}function initializeAIHelp(){console.log("initializeAIHelp called");// Add event listener for AI help button
const a=document.getElementById("get-ai-help");console.log("AI help button element:",a),a?(a.addEventListener("click",getAIExplanation),console.log("AI help button initialized successfully")):console.error("AI help button not found - this will prevent the feature from working!");// Suggested reading button
const b=document.getElementById("get-suggested-reading");b&&b.addEventListener("click",async()=>{try{const a=document.getElementById("question"),b=document.getElementById("answer-display"),c=a?.textContent?.trim()||"",d=b?.textContent?.trim()||"",e=d.replace(/^ANSWER:\\s*/i,""),f=await fetch("/api/ai-help/suggest-reading",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:c,answer:e,category:getCurrentCategory()})});if(!f.ok){const a=await f.json().catch(()=>({}));throw new Error(a.error||"Failed to get suggestions")}const g=await f.json();renderSuggestions(g.suggestions)}catch(a){console.error("Failed to get suggested reading:",a)}});// Add event listener for test button
const c=document.getElementById("test-ai-help");console.log("Test button element:",c),c?(c.addEventListener("click",testAIHelp),console.log("Test button initialized successfully")):console.error("Test button not found!");// Also check if the AI help section exists
const d=document.getElementById("ai-help-section");console.log("AI help section element:",d),d||console.error("AI help section not found - this is a critical error!"),console.log("AI help initialization complete")}// Test function for debugging
function testAIHelp(){console.log("=== AI HELP DEBUG TEST ==="),console.log("1. Testing element existence:"),console.log("   - AI help section:",document.getElementById("ai-help-section")),console.log("   - AI help button:",document.getElementById("get-ai-help")),console.log("   - AI explanation div:",document.getElementById("ai-explanation")),console.log("2. Testing showAIHelpSection function:"),showAIHelpSection(),console.log("3. Current visibility states:");const a=document.getElementById("ai-help-section"),b=document.getElementById("ai-explanation");a&&(console.log("   - AI help section classes:",a.className),console.log("   - AI help section hidden:",a.classList.contains("d-none"))),b&&(console.log("   - AI explanation classes:",b.className),console.log("   - AI explanation hidden:",b.classList.contains("d-none"))),console.log("=== END DEBUG TEST ===")}// Expose a small debug API so you can call from DevTools
// Example: AIHelpDebug.test()
window.AIHelpDebug={show:showAIHelpSection,hide:hideAIHelpSection,explain:getAIExplanation,init:initializeAIHelp,test:testAIHelp},console.log("AIHelpDebug available. Try AIHelpDebug.test() in console.");