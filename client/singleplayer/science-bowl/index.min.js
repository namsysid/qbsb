console.log("Science Bowl script loaded");import api from"../../scripts/api/index.js";import questionStats from"../../scripts/auth/question-stats.js";import audio from"../../audio/index.js";import{MODE_ENUM}from"../../../quizbowl/constants.js";import Player from"../../../quizbowl/Player.js";import ClientScienceBowlRoom from"../ClientScienceBowlRoom.js";import{arrayToRange,rangeToArray}from"../../scripts/utilities/ranges.js";import createTossupGameCard from"../../scripts/utilities/tossup-game-card.js";import{getDropdownValues}from"../../scripts/utilities/dropdown-checklist.js";import ScienceBowlCategoryModal from"../../scripts/components/ScienceBowlCategoryModal.min.js";import DifficultyDropdown from"../../scripts/components/DifficultyDropdown.min.js";import upsertPlayerItem from"../../scripts/upsertPlayerItem.js";import aiBots from"../ai-mode/ai-bots.js";import AIBot from"../ai-mode/AIBot.js";import{SBCATEGORIES}from"../../../quizbowl/categories.js";import ScienceBowlCategoryManager from"../../../quizbowl/ScienceBowlCategoryManager.js";let maxPacketNumber=24;const modeVersion="2025-01-14",queryVersion="2025-05-07",settingsVersion="2024-10-16",USER_ID="user",USERNAME="user",VERSION="2025-05-07",room=new ClientScienceBowlRoom;window.room=room,room.players[USER_ID]=new Player(USER_ID),room.categoryManager=new ScienceBowlCategoryManager;// Load saved category state
const savedCategoryState=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-categories")||"{}");console.log("Loading saved category state:",savedCategoryState),savedCategoryState.version===queryVersion&&(room.categoryManager.import(savedCategoryState),console.log("Updating checkbox states after loading saved state"),document.querySelectorAll(".category-checkbox").forEach(a=>{a.checked=room.categoryManager.categories.includes(a.id)}));const aiBot=new AIBot(room);aiBot.setAIBot(aiBots["average-high-school"][0]),aiBot.active=!1;const socket={send:onmessage,sendToServer:a=>room.message(USER_ID,a)};room.sockets[USER_ID]=socket;function onmessage(a){const b=JSON.parse(a);switch(b.type){case"alert":return window.alert(b.message);case"buzz":return buzz(b);case"clear-stats":return clearStats(b);case"end":return next(b);case"end-of-set":return endOfSet(b);case"give-answer":return giveAnswer(b);case"next":return next(b);case"no-questions-found":return noQuestionsFound(b);case"pause":return pause(b);case"reveal-answer":return revealAnswer(b);case"set-categories":return setCategories(b);case"set-difficulties":return setDifficulties(b);case"set-mode":return setMode(b);case"set-reading-speed":return setReadingSpeed(b);case"set-strictness":return setStrictness(b);case"set-packet-numbers":return setPacketNumbers(b);case"set-set-name":return setSetName(b);case"set-year-range":return setYearRange(b);case"skip":return next(b);case"start":return next(b);case"timer-update":return updateTimerDisplay(b.timeRemaining);case"toggle-ai-mode":return toggleAiMode(b);case"toggle-correct":return toggleCorrect(b);case"toggle-powermark-only":return togglePowermarkOnly(b);case"toggle-rebuzz":return toggleRebuzz(b);case"toggle-show-history":return toggleShowHistory(b);case"toggle-standard-only":return toggleStandardOnly(b);case"toggle-timer":return toggleTimer(b);case"toggle-type-to-answer":return toggleTypeToAnswer(b);case"update-question":return updateQuestion(b)}}function buzz({timer:a,userId:b,username:c}){if(audio.soundEffects&&audio.buzz.play(),b===USER_ID){document.getElementById("pause").disabled=!0;const a=document.getElementById("type-to-answer").checked;a&&(document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),document.getElementById("buzz").disabled=!0)}}function clearStats({userId:a}){updateStatDisplay(room.players[a])}function endOfSet(){window.alert("You have reached the end of the set")}async function giveAnswer({directive:a,directedPrompt:b,perQuestionCelerity:c,score:d,tossup:e,userId:f}){return"prompt"===a?(document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),void(document.getElementById("answer-input").placeholder=b?`Prompt: "${b}"`:"Prompt")):void(f===USER_ID?updateStatDisplay(room.players[USER_ID]):aiBot.active&&upsertPlayerItem(aiBot.player),document.getElementById("answer-input").value="",document.getElementById("answer-input").blur(),document.getElementById("answer-input").placeholder="Enter answer",document.getElementById("answer-input-group").classList.add("d-none"),document.getElementById("next").disabled=!1,room.settings.rebuzz&&"reject"===a&&(document.getElementById("buzz").disabled=!1,document.getElementById("buzz").textContent="Buzz",document.getElementById("pause").disabled=!1),audio.soundEffects&&f===USER_ID&&("accept"===a&&10<d?audio.power.play():"accept"===a&&10===d?audio.correct.play():"reject"===a&&audio.incorrect.play()))}async function next({packetLength:a,oldTossup:b,tossup:c,type:d}){if("start"===d&&(document.getElementById("next").disabled=!1,document.getElementById("settings").classList.add("d-none")),"start"!==d&&createTossupGameCard({starred:room.mode===MODE_ENUM.STARRED||room.mode!==MODE_ENUM.LOCAL&&null,tossup:b}),document.getElementById("answer").textContent="",document.getElementById("question").textContent="",document.getElementById("toggle-correct").textContent="I was wrong",document.getElementById("toggle-correct").classList.add("d-none"),"end"===d?(document.getElementById("buzz").disabled=!0,document.getElementById("next").disabled=!0,document.getElementById("pause").disabled=!0):(document.getElementById("buzz").textContent="Buzz",document.getElementById("buzz").disabled=!1,document.getElementById("next").textContent="Skip",document.getElementById("packet-number-info").textContent=c.packet.number,document.getElementById("packet-length-info").textContent=room.mode===MODE_ENUM.SET_NAME?a:"-",document.getElementById("pause").textContent="Pause",document.getElementById("pause").disabled=!1,document.getElementById("question-number-info").textContent=c.number,document.getElementById("set-name-info").textContent=c.set.name),("end"===d||"next"===d)&&room.previous.userId===USER_ID&&room.mode!==MODE_ENUM.LOCAL){const a=room.previous.isCorrect?room.previous.inPower?room.previous.powerValue:10:room.previous.endOfQuestion?0:room.previous.negValue;questionStats.recordTossup({_id:room.previous.tossup._id,celerity:room.previous.celerity,isCorrect:room.previous.isCorrect,multiplayer:!1,pointValue:a})}}function noQuestionsFound(){window.alert("No questions found")}function pause({paused:a}){document.getElementById("buzz").disabled=a,document.getElementById("pause").textContent=a?"Resume":"Pause"}function revealAnswer({answer:a,question:b}){document.getElementById("question").innerHTML=b,document.getElementById("answer").innerHTML="ANSWER: "+a,document.getElementById("pause").disabled=!0,document.getElementById("buzz").disabled=!0,document.getElementById("buzz").textContent="Buzz",document.getElementById("next").disabled=!1,document.getElementById("next").textContent="Next",document.getElementById("start").disabled=!1,document.getElementById("toggle-correct").classList.remove("d-none"),document.getElementById("toggle-correct").textContent=room.previous.isCorrect?"I was wrong":"I was right"}function setCategories({alternateSubcategories:a,categories:b,subcategories:c,percentView:d,categoryPercents:e}){// Save category state to localStorage
room.categoryManager.loadCategoryModal(),window.localStorage.setItem("singleplayer-science-bowl-categories",JSON.stringify({...room.categoryManager.export(),version:queryVersion})),window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setDifficulties({difficulties:a}){window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setStrictness({strictness:a}){document.getElementById("set-strictness").value=a,document.getElementById("strictness-display").textContent=a,window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function setPacketNumbers({packetNumbers:a}){document.getElementById("packet-number").value=arrayToRange(a),window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setReadingSpeed({readingSpeed:a}){document.getElementById("reading-speed").value=a,document.getElementById("reading-speed-display").textContent=a,window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}async function setSetName({setName:a,setLength:b}){document.getElementById("set-name").value=a;// make border red if set name is not in set list
const c=!a||api.getSetList().includes(a);document.getElementById("set-name").classList.toggle("is-invalid",!c),maxPacketNumber=b,document.getElementById("packet-number").placeholder="Packet Numbers"+(maxPacketNumber?` (1-${maxPacketNumber})`:""),window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function setYearRange({minYear:a,maxYear:b}){$("#slider").slider("values",[a,b]),document.getElementById("year-range-a").textContent=a,document.getElementById("year-range-b").textContent=b,window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleAiMode({aiMode:a}){a&&upsertPlayerItem(aiBot.player),aiBot.active=a,document.getElementById("ai-settings").disabled=!a,document.getElementById("toggle-ai-mode").checked=a,document.getElementById("player-list-group").classList.toggle("d-none",!a),document.getElementById("player-list-group-hr").classList.toggle("d-none",!a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleCorrect({correct:a,userId:b}){b!==USER_ID||document.getElementById("toggle-correct").classList.add("d-none")}function togglePowermarkOnly({powermarkOnly:a}){document.getElementById("toggle-powermark-only").checked=a,window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleRebuzz({rebuzz:a}){document.getElementById("toggle-rebuzz").checked=a,window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function setMode({mode:a,setName:b}){document.getElementById("set-mode").value=a,document.getElementById("local-packet-settings").classList.toggle("d-none","local packet"!==a),document.getElementById("set-settings").classList.toggle("d-none","select by set name"!==a),document.getElementById("difficulty-settings").classList.toggle("d-none","local packet"===a),document.getElementById("toggle-powermark-only").disabled="local packet"===a,document.getElementById("toggle-standard-only").disabled="local packet"===a,document.getElementById("category-select-button").disabled="local packet"===a,document.getElementById("ai-settings").disabled="local packet"===a||!room.settings.aiMode,document.getElementById("toggle-ai-mode").disabled="local packet"===a,document.getElementById("clear-stats").disabled="local packet"===a,document.getElementById("set-name").value=b||"",window.localStorage.setItem("singleplayer-science-bowl-mode",JSON.stringify({mode:a,setName:b,version:modeVersion}))}function toggleShowHistory({showHistory:a}){document.getElementById("toggle-show-history").checked=a,document.getElementById("room-history").classList.toggle("d-none",!a),window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleStandardOnly({standardOnly:a}){document.getElementById("toggle-standard-only").checked=a,window.localStorage.setItem("singleplayer-science-bowl-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleTimer({timer:a}){document.getElementById("toggle-timer").checked=a,window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleTypeToAnswer({typeToAnswer:a}){document.getElementById("type-to-answer").checked=a,window.localStorage.setItem("singleplayer-science-bowl-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function updateQuestion({word:a}){document.getElementById("question").textContent+=a+" "}function updateStatDisplay({powers:a,tens:b,negs:c,tuh:d,points:e,celerity:f}){document.getElementById("statline").textContent=`${a}/${b}/${c} with ${d} tossups seen (${e} pts, celerity: ${f.toFixed(2)})`}function updateTimerDisplay(a){const b=Math.floor(a/10);document.getElementById("timer").querySelector(".face").textContent=b,document.getElementById("timer").querySelector(".fraction").textContent="."+a%10}// Initialize the room
document.addEventListener("DOMContentLoaded",()=>{console.log("DOM loaded, setting up event handlers"),console.log("Initializing room...");const a=new ClientScienceBowlRoom;console.log("Room initialized:",a),console.log("Category manager:",a.categoryManager),console.log("Initial categories:",a.categoryManager.categories);// Load saved settings
const b=localStorage.getItem("singleplayer-science-bowl-settings");if(console.log("Loading saved settings:",b),b){const c=JSON.parse(b);c.version===settingsVersion&&(a.settings={...a.settings,...c},document.getElementById("toggle-ai-mode").checked=a.settings.aiMode,document.getElementById("toggle-rebuzz").checked=a.settings.rebuzz,document.getElementById("toggle-show-history").checked=a.settings.showHistory,document.getElementById("toggle-timer").checked=a.settings.timer,document.getElementById("type-to-answer").checked=a.settings.typeToAnswer,document.getElementById("set-strictness").value=a.settings.strictness,document.getElementById("strictness-display").textContent=a.settings.strictness,document.getElementById("reading-speed").value=a.settings.readingSpeed,document.getElementById("reading-speed-display").textContent=a.settings.readingSpeed)}// Load saved category state
const c=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-categories")||"{}");console.log("Loading saved category state:",c),c.version===queryVersion&&(a.categoryManager.import(c),console.log("Updating checkbox states after loading saved state"),document.querySelectorAll(".category-checkbox").forEach(b=>{b.checked=a.categoryManager.categories.includes(b.id)}));// Load saved mode
const d=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-mode")||"{}");d.version===modeVersion&&setMode(d);// Load saved query
const e=JSON.parse(window.localStorage.getItem("singleplayer-science-bowl-query")||"{}");e.version===queryVersion&&(a.query={...a.query,...e},document.getElementById("set-name").value=a.query.setName,document.getElementById("packet-number").value=arrayToRange(a.query.packetNumbers),$("#slider").slider("values",[a.query.minYear,a.query.maxYear]),document.getElementById("year-range-a").textContent=a.query.minYear,document.getElementById("year-range-b").textContent=a.query.maxYear),console.log("Setting up event handlers immediately");const f=document.getElementById("category-modal-root");if(console.log("Found modal element:",f),f){console.log("About to initialize category modal handlers");try{// Add modal show/hide handlers
f.addEventListener("show.bs.modal",()=>{console.log("Modal shown"),console.log("Current categories:",a.categoryManager.categories),a.categoryManager.loadCategoryModal(),document.querySelectorAll(".category-checkbox").forEach(b=>{b.checked=a.categoryManager.categories.includes(b.id)})}),f.addEventListener("hidden.bs.modal",()=>{console.log("Modal hidden"),console.log("Current categories:",a.categoryManager.categories),socket.sendToServer({type:"set-categories",...a.categoryManager.export()})}),console.log("Modal show/hide handlers attached"),console.log("Category modal handlers initialized successfully")}catch(a){console.error("Error initializing category modal:",a)}}else console.error("Modal root element not found");// Add other event handlers
document.getElementById("answer-form").addEventListener("submit",b=>{b.preventDefault();const c=document.getElementById("answer-input").value;a.message(USER_ID,{type:"give-answer",givenAnswer:c})}),document.getElementById("buzz").addEventListener("click",()=>{a.message(USER_ID,{type:"buzz"})}),document.getElementById("clear-stats").addEventListener("click",()=>{a.message(USER_ID,{type:"clear-stats"})}),document.getElementById("next").addEventListener("click",()=>{a.message(USER_ID,{type:"next"})}),document.getElementById("pause").addEventListener("click",()=>{a.message(USER_ID,{type:"pause"})}),document.getElementById("start").addEventListener("click",()=>{a.message(USER_ID,{type:"start"})}),document.getElementById("toggle-correct").addEventListener("click",()=>{a.message(USER_ID,{type:"toggle-correct"})}),document.getElementById("toggle-ai-mode").addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-ai-mode",aiMode:b.target.checked})}),document.getElementById("toggle-rebuzz").addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-rebuzz",rebuzz:b.target.checked})}),document.getElementById("toggle-show-history").addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-show-history",showHistory:b.target.checked})}),document.getElementById("toggle-timer").addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-timer",timer:b.target.checked})}),document.getElementById("type-to-answer").addEventListener("change",b=>{a.message(USER_ID,{type:"toggle-type-to-answer",typeToAnswer:b.target.checked})}),document.getElementById("set-strictness").addEventListener("input",b=>{a.message(USER_ID,{type:"set-strictness",strictness:parseInt(b.target.value)})}),document.getElementById("reading-speed").addEventListener("input",b=>{a.message(USER_ID,{type:"set-reading-speed",readingSpeed:parseInt(b.target.value)})}),document.addEventListener("keydown",b=>{if("INPUT"!==b.target.tagName)switch(b.key){case" ":return a.message(USER_ID,{type:"buzz"});case"n":return a.message(USER_ID,{type:"next"});case"p":return a.message(USER_ID,{type:"pause"});case"s":return a.message(USER_ID,{type:"start"})}}),a.message(USER_ID,{type:"start"})});